<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éŸ³ä¹æœåŠ¡å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: #4CAF50;
            color: white;
            padding: 10px 0;
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
        }

        .login-form {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 50px auto;
        }

        .login-form h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
        }

        .btn:hover {
            background-color: #45a049;
        }

        .btn-block {
            width: 100%;
        }

        .content {
            display: none;
        }

        .nav {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .nav ul {
            list-style: none;
            display: flex;
            gap: 10px;
        }

        .nav li {
            margin-right: 10px;
        }

        .nav a {
            text-decoration: none;
            color: #333;
            padding: 5px 10px;
            border-radius: 3px;
        }

        .nav a:hover {
            background-color: #f0f0f0;
        }

        .section {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section h2 {
            margin-bottom: 15px;
        }

        .search-bar {
            display: flex;
            margin-bottom: 20px;
        }

        .search-bar input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px 0 0 3px;
        }

        .search-bar button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 0 3px 3px 0;
            cursor: pointer;
        }

        .list {
            list-style: none;
        }

        .list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list li:hover {
            background-color: #f9f9f9;
        }

        .list li:last-child {
            border-bottom: none;
        }

        .play-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .play-btn:hover {
            background-color: #45a049;
        }

        .player {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .player-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .player-info {
            flex: 1;
        }

        .player-controls {
            display: flex;
            gap: 10px;
        }

        .player audio {
            width: 100%;
            margin-top: 10px;
        }

        .create-playlist {
            margin-bottom: 20px;
        }

        .create-playlist input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin-right: 10px;
        }

        .view-controls {
            margin: 15px 0;
            display: flex;
            gap: 10px;
        }

        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .song-card {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            transition: transform 0.2s;
        }

        .song-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .song-card h4 {
            margin-bottom: 10px;
        }

        .song-card p {
            margin-bottom: 15px;
            color: #666;
        }

        .card-cover-container {
            width: 100%;
            height: 200px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 5px;
            background-color: #f0f0f0;
        }

        .card-cover {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-cover-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e0e0e0;
            color: #999;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .nav ul {
                flex-direction: column;
            }

            .player-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .player-controls {
                margin-top: 10px;
            }

            .card-container {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>éŸ³ä¹æœåŠ¡å™¨</h1>
    </header>

    <div class="container">
        <!-- ç™»å½•è¡¨å• -->
        <div class="login-form" id="loginForm">
            <h2>ç™»å½•</h2>
            <div class="form-group">
                <label for="username">ç”¨æˆ·å</label>
                <input type="text" id="username" placeholder="admin" value="admin">
            </div>
            <div class="form-group">
                <label for="password">å¯†ç </label>
                <input type="password" id="password" placeholder="admin" value="admin">
            </div>
            <button class="btn btn-block" onclick="login()">ç™»å½•</button>
        </div>

        <!-- ä¸»å†…å®¹ -->
        <div class="content" id="content">
            <!-- å¯¼èˆª -->
            <nav class="nav">
                <ul>
                    <li><a href="#" onclick="showSection('home')">é¦–é¡µ</a></li>
                    <li><a href="#" onclick="showSection('artists')">è‰ºæœ¯å®¶</a></li>
                    <li><a href="#" onclick="showSection('albums')">ä¸“è¾‘</a></li>
                    <li><a href="#" onclick="showSection('playlists')">æ­Œå•</a></li>
                    <li><a href="#" onclick="showSection('upload')">ä¸Šä¼ </a></li>
                    <li><a href="#" onclick="showSection('sync')">åŒæ­¥</a></li>
                    <li><a href="#" onclick="showSection('webdav')">WebDAV</a></li>
                    <li><a href="#" onclick="logout()">é€€å‡º</a></li>
                </ul>
            </nav>

            <!-- é¦–é¡µ -->
            <div class="section" id="home">
                <h2>é¦–é¡µ</h2>
                <div class="search-bar">
                    <input type="text" id="searchQuery" placeholder="æœç´¢éŸ³ä¹...">
                    <button onclick="searchMusic()">æœç´¢</button>
                </div>
                <div class="view-controls">
                    <button class="btn" onclick="switchView('list')">åˆ—è¡¨è§†å›¾</button>
                    <button class="btn" onclick="switchView('card')">å¡è§†å›¾</button>
                </div>
                <h3>çƒ­é—¨æ­Œæ›²</h3>
                <div id="songsContainer">
                    <ul class="list" id="songsList">
                        <!-- æ­Œæ›²åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </ul>
                    <div class="card-container" id="songsCard" style="display: none;">
                        <!-- æ­Œæ›²å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </div>
                    <div id="pagination" style="margin-top: 20px; text-align: center;">
                        <button class="btn" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
                        <span id="pageInfo">ç¬¬ 1 é¡µ</span>
                        <button class="btn" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
                    </div>
                </div>
            </div>

            <!-- è‰ºæœ¯å®¶ -->
            <div class="section" id="artists" style="display: none;">
                <h2>è‰ºæœ¯å®¶</h2>
                <ul class="list" id="artistsList">
                    <!-- è‰ºæœ¯å®¶åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </ul>
            </div>

            <!-- ä¸“è¾‘ -->
            <div class="section" id="albums" style="display: none;">
                <h2>ä¸“è¾‘</h2>
                <ul class="list" id="albumsList">
                    <!-- ä¸“è¾‘åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </ul>
            </div>

            <!-- æ­Œå• -->
            <div class="section" id="playlists" style="display: none;">
                <h2>æ­Œå•</h2>
                <div class="create-playlist">
                    <input type="text" id="playlistName" placeholder="æ­Œå•åç§°">
                    <button class="btn" onclick="createPlaylist()">åˆ›å»ºæ­Œå•</button>
                </div>
                <ul class="list" id="playlistsList">
                    <!-- æ­Œå•åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                </ul>
            </div>

            <!-- ä¸Šä¼  -->
            <div class="section" id="upload" style="display: none;">
                <h2>ä¸Šä¼ éŸ³ä¹</h2>
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="file">é€‰æ‹©æ–‡ä»¶</label>
                        <input type="file" id="file" name="file" accept=".mp3,.wav,.flac,.ogg" required>
                    </div>
                    <div class="form-group">
                        <label for="uploadTitle">æ­Œæ›²æ ‡é¢˜ (å¯é€‰ï¼Œè‡ªåŠ¨æå–)</label>
                        <input type="text" id="uploadTitle" name="title" placeholder="æ­Œæ›²æ ‡é¢˜">
                    </div>
                    <div class="form-group">
                        <label for="uploadArtist">è‰ºæœ¯å®¶ (å¯é€‰ï¼Œè‡ªåŠ¨æå–)</label>
                        <input type="text" id="uploadArtist" name="artist" placeholder="è‰ºæœ¯å®¶">
                    </div>
                    <div class="form-group">
                        <label for="uploadAlbum">ä¸“è¾‘ (å¯é€‰ï¼Œè‡ªåŠ¨æå–)</label>
                        <input type="text" id="uploadAlbum" name="album" placeholder="ä¸“è¾‘">
                    </div>
                    <div class="form-group">
                        <label for="uploadFormat">æ ¼å¼ (å¯é€‰ï¼Œè‡ªåŠ¨æå–)</label>
                        <input type="text" id="uploadFormat" name="format" placeholder="å¦‚: MP3">
                    </div>
                    <div class="form-group">
                        <label for="uploadEncoding">ç¼–ç  (å¯é€‰)</label>
                        <input type="text" id="uploadEncoding" name="encoding" placeholder="å¦‚: CBR 320kbps">
                    </div>
                    <div class="form-group">
                        <label for="uploadTrack">è½¨é“ (å¯é€‰ï¼Œè‡ªåŠ¨æå–)</label>
                        <input type="number" id="uploadTrack" name="track" placeholder="å¦‚: 1">
                    </div>
                    <div class="form-group">
                        <label for="uploadDuration">æ—¶é•¿(ç§’) (å¯é€‰ï¼Œè‡ªåŠ¨æå–)</label>
                        <input type="number" id="uploadDuration" name="duration" placeholder="å¦‚: 180">
                    </div>
                    <div class="form-group">
                        <label for="uploadQuality">éŸ³è´¨ (å¯é€‰)</label>
                        <input type="text" id="uploadQuality" name="quality" placeholder="å¦‚: 320kbps">
                    </div>
                    <button type="button" class="btn btn-block" onclick="uploadMusic()">ä¸Šä¼ </button>
                </form>
                <div id="uploadResult" style="margin-top: 20px;"></div>
            </div>
            
            <!-- åŒæ­¥ -->
            <div class="section" id="sync" style="display: none;">
                <h2>éŸ³ä¹åŒæ­¥</h2>
                <div class="form-group">
                    <label>åŒæ­¥çŠ¶æ€</label>
                    <div id="syncStatus" style="padding: 10px; background-color: #f0f0f0; border-radius: 3px;">
                        åŒæ­¥æœåŠ¡å·²å¯åŠ¨ï¼Œæ¯5åˆ†é’Ÿè‡ªåŠ¨åŒæ­¥ä¸€æ¬¡
                    </div>
                </div>
                <div class="form-group">
                    <label>åŒæ­¥ç›®å½•</label>
                    <div style="padding: 10px; background-color: #f0f0f0; border-radius: 3px;">
                        music/
                    </div>
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-block" onclick="syncMusic()">ç«‹å³åŒæ­¥</button>
                </div>
                <div id="syncResult" style="margin-top: 20px;"></div>
            </div>
            
            <!-- WebDAV -->
            <div class="section" id="webdav" style="display: none;">
                <h2>WebDAVè®¾ç½®</h2>
                <div class="form-group">
                    <h3>æ·»åŠ WebDAVé…ç½®</h3>
                    <div class="form-group">
                        <label for="webdavUrl">WebDAV URL</label>
                        <input type="text" id="webdavUrl" placeholder="https://example.com/webdav">
                    </div>
                    <div class="form-group">
                        <label for="webdavUsername">ç”¨æˆ·å</label>
                        <input type="text" id="webdavUsername" placeholder="Username">
                    </div>
                    <div class="form-group">
                        <label for="webdavPassword">å¯†ç </label>
                        <input type="password" id="webdavPassword" placeholder="Password">
                    </div>
                    <button type="button" class="btn btn-block" onclick="addWebdavConfig()">æ·»åŠ </button>
                </div>
                <div class="form-group">
                    <h3>å·²é…ç½®çš„WebDAV</h3>
                    <ul class="list" id="webdavList">
                        <!-- WebDAVé…ç½®åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </ul>
                </div>
                <div class="form-group" id="webdavBrowser" style="display: none;">
                    <h3>WebDAVæ–‡ä»¶æµè§ˆ</h3>
                    <div class="form-group">
                        <button type="button" class="btn" onclick="navigateWebdavUp()">ä¸Šä¸€çº§</button>
                        <span id="currentWebdavPath">/</span>
                    </div>
                    <ul class="list" id="webdavFilesList">
                        <!-- WebDAVæ–‡ä»¶åˆ—è¡¨å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                    </ul>
                </div>
                <div id="webdavResult" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- æ’­æ”¾å™¨ -->
    <div class="player" id="player" style="display: none;">
        <div class="player-content">
            <div class="player-info">
                <h3 id="currentSongTitle">æœªæ’­æ”¾</h3>
                <p id="currentSongArtist">-</p>
            </div>
            <div class="player-controls">
                <button class="btn" onclick="playPause()">æ’­æ”¾</button>
                <button class="btn" onclick="stop()">åœæ­¢</button>
            </div>
        </div>
        <audio id="audioPlayer" controls>
            æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘å…ƒç´ ã€‚
        </audio>
    </div>

    <script>
        let authParams = '';
        let currentSong = null;
        let currentView = 'list';
        let currentPage = 1;
        let pageSize = 20;

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
        window.onload = function() {
            const savedAuth = localStorage.getItem('authParams');
            if (savedAuth) {
                authParams = savedAuth;
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                loadHome();
            }
        };

        // ç™»å½•
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            authParams = `u=${username}&p=${password}`;
            // å­˜å‚¨ç™»å½•ä¿¡æ¯åˆ°localStorage
            localStorage.setItem('authParams', authParams);
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            loadHome();
        }

        // é€€å‡º
        function logout() {
            authParams = '';
            // æ¸…é™¤localStorageä¸­çš„ç™»å½•ä¿¡æ¯
            localStorage.removeItem('authParams');
            document.getElementById('content').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('player').style.display = 'none';
        }

        // æ˜¾ç¤ºæŒ‡å®šéƒ¨åˆ†
        function showSection(sectionId) {
            // éšè—æ‰€æœ‰éƒ¨åˆ†
            document.getElementById('home').style.display = 'none';
            document.getElementById('artists').style.display = 'none';
            document.getElementById('albums').style.display = 'none';
            document.getElementById('playlists').style.display = 'none';
            document.getElementById('upload').style.display = 'none';
            document.getElementById('sync').style.display = 'none';
            document.getElementById('webdav').style.display = 'none';

            // æ˜¾ç¤ºé€‰ä¸­éƒ¨åˆ†
            document.getElementById(sectionId).style.display = 'block';

            // åŠ è½½å¯¹åº”å†…å®¹
            if (sectionId === 'artists') {
                loadArtists();
            } else if (sectionId === 'albums') {
                loadAlbums();
            } else if (sectionId === 'playlists') {
                loadPlaylists();
            } else if (sectionId === 'webdav') {
                loadWebdavConfig();
            }
        }

        // åŠ è½½é¦–é¡µ
        function loadHome() {
            fetch(`/rest/getIndexes?${authParams}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        loadSongs();
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // åŠ è½½æ­Œæ›²åˆ—è¡¨
        function loadSongs() {
            const offset = (currentPage - 1) * pageSize;
            fetch(`/rest/search3?${authParams}&query=&songCount=${pageSize}&offset=${offset}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const songs = data['subsonic-response'].searchResult3.song;
                        
                        if (currentView === 'list') {
                            const songsList = document.getElementById('songsList');
                            songsList.innerHTML = '';

                            if (songs && songs.length > 0) {
                                songs.forEach(song => {
                                    const li = document.createElement('li');
                                    li.innerHTML = `
                                        <div>
                                            <strong>${song.title}</strong>
                                            <br>
                                            <small>${song.artist} - ${song.album}</small>
                                            <br>
                                            <small>æ ¼å¼: ${song.format || 'æœªçŸ¥'} | è´¨é‡: ${song.quality || 'æœªçŸ¥'} | æ—¶é•¿: ${song.duration || 0}ç§’</small>
                                        </div>
                                        <button class="play-btn" onclick="playSong(${song.id}, '${song.title}', '${song.artist}')">æ’­æ”¾</button>
                                    `;
                                    songsList.appendChild(li);
                                });
                            } else {
                                songsList.innerHTML = '<li>æ²¡æœ‰æ‰¾åˆ°æ­Œæ›²</li>';
                            }
                        } else if (currentView === 'card') {
                            const songsCard = document.getElementById('songsCard');
                            songsCard.innerHTML = '';

                            if (songs && songs.length > 0) {
                                songs.forEach(song => {
                                    const card = document.createElement('div');
                                    card.className = 'song-card';
                                    const coverArt = song.coverArt ? `<img src="/music/${song.coverArt.split('/').pop()}" alt="${song.album}" class="card-cover">` : '<div class="card-cover-placeholder">æ— å°é¢</div>';
                                    card.innerHTML = `
                                        <div class="card-cover-container">
                                            ${coverArt}
                                        </div>
                                        <h4>${song.title}</h4>
                                        <p>${song.artist} - ${song.album}</p>
                                        <button class="btn" onclick="playSong(${song.id}, '${song.title}', '${song.artist}')">æ’­æ”¾</button>
                                    `;
                                    songsCard.appendChild(card);
                                });
                            } else {
                                songsCard.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°æ­Œæ›²</p>';
                            }
                        }
                        
                        // æ§åˆ¶åˆ†é¡µæŒ‰é’®çŠ¶æ€
                        const nextButton = document.querySelector('#pagination button:last-child');
                        const prevButton = document.querySelector('#pagination button:first-child');
                        
                        // ç¦ç”¨æˆ–å¯ç”¨ä¸Šä¸€é¡µæŒ‰é’®
                        if (currentPage === 1) {
                            prevButton.disabled = true;
                            prevButton.style.opacity = '0.5';
                        } else {
                            prevButton.disabled = false;
                            prevButton.style.opacity = '1';
                        }
                        
                        // ç¦ç”¨æˆ–å¯ç”¨ä¸‹ä¸€é¡µæŒ‰é’®
                        if (!songs || songs.length < pageSize) {
                            nextButton.disabled = true;
                            nextButton.style.opacity = '0.5';
                        } else {
                            nextButton.disabled = false;
                            nextButton.style.opacity = '1';
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // åŠ è½½è‰ºæœ¯å®¶åˆ—è¡¨
        function loadArtists() {
            fetch(`/rest/getArtists?${authParams}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const artists = data['subsonic-response'].artists.artist;
                        const artistsList = document.getElementById('artistsList');
                        artistsList.innerHTML = '';

                        if (artists && artists.length > 0) {
                            artists.forEach(artist => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <div>
                                        <strong>${artist.name}</strong>
                                    </div>
                                    <button class="btn" onclick="loadArtistAlbums(${artist.id})">æŸ¥çœ‹ä¸“è¾‘</button>
                                `;
                                artistsList.appendChild(li);
                            });
                        } else {
                            artistsList.innerHTML = '<li>æ²¡æœ‰æ‰¾åˆ°è‰ºæœ¯å®¶</li>';
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // åŠ è½½è‰ºæœ¯å®¶ä¸“è¾‘
        function loadArtistAlbums(artistId) {
            fetch(`/rest/getArtist?${authParams}&id=${artistId}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const artist = data['subsonic-response'].artist;
                        const albums = artist.album;
                        const albumsList = document.getElementById('albumsList');
                        albumsList.innerHTML = '';

                        if (albums && albums.length > 0) {
                            albums.forEach(album => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <div>
                                        <strong>${album.name}</strong>
                                        <br>
                                        <small>${artist.name}</small>
                                    </div>
                                    <button class="btn" onclick="loadAlbumSongs(${album.id})">æŸ¥çœ‹æ­Œæ›²</button>
                                `;
                                albumsList.appendChild(li);
                            });
                        } else {
                            albumsList.innerHTML = '<li>æ²¡æœ‰æ‰¾åˆ°ä¸“è¾‘</li>';
                        }

                        // æ˜¾ç¤ºä¸“è¾‘é¡µé¢
                        showSection('albums');
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // åŠ è½½ä¸“è¾‘åˆ—è¡¨
        function loadAlbums() {
            fetch(`/rest/getAlbumList?${authParams}&type=newest&size=20`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const albums = data['subsonic-response'].albumList.album;
                        const albumsList = document.getElementById('albumsList');
                        albumsList.innerHTML = '';

                        if (albums && albums.length > 0) {
                            albums.forEach(album => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <div>
                                        <strong>${album.name}</strong>
                                        <br>
                                        <small>${album.artist}</small>
                                    </div>
                                    <button class="btn" onclick="loadAlbumSongs(${album.id})">æŸ¥çœ‹æ­Œæ›²</button>
                                `;
                                albumsList.appendChild(li);
                            });
                        } else {
                            albumsList.innerHTML = '<li>æ²¡æœ‰æ‰¾åˆ°ä¸“è¾‘</li>';
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // åŠ è½½ä¸“è¾‘æ­Œæ›²
        function loadAlbumSongs(albumId) {
            fetch(`/rest/getAlbum?${authParams}&id=${albumId}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const album = data['subsonic-response'].album;
                        const songs = album.song;
                        const songsList = document.getElementById('songsList');
                        songsList.innerHTML = '';

                        if (songs && songs.length > 0) {
                            songs.forEach(song => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <div>
                                        <strong>${song.title}</strong>
                                        <br>
                                        <small>${album.artist} - ${album.name}</small>
                                    </div>
                                    <button class="play-btn" onclick="playSong(${song.id}, '${song.title}', '${album.artist}')">æ’­æ”¾</button>
                                `;
                                songsList.appendChild(li);
                            });
                        } else {
                            songsList.innerHTML = '<li>æ²¡æœ‰æ‰¾åˆ°æ­Œæ›²</li>';
                        }

                        // æ˜¾ç¤ºé¦–é¡µ
                        showSection('home');
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // åŠ è½½æ­Œå•åˆ—è¡¨
        function loadPlaylists() {
            fetch(`/rest/getPlaylists?${authParams}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const playlists = data['subsonic-response'].playlists.playlist;
                        const playlistsList = document.getElementById('playlistsList');
                        playlistsList.innerHTML = '';

                        if (playlists && playlists.length > 0) {
                            playlists.forEach(playlist => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <div>
                                        <strong>${playlist.name}</strong>
                                        <br>
                                        <small>åˆ›å»ºäº: ${new Date(playlist.created).toLocaleString()}</small>
                                    </div>
                                    <button class="btn" onclick="loadPlaylistSongs(${playlist.id})">æŸ¥çœ‹æ­Œæ›²</button>
                                `;
                                playlistsList.appendChild(li);
                            });
                        } else {
                            playlistsList.innerHTML = '<li>æ²¡æœ‰æ‰¾åˆ°æ­Œå•</li>';
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // åŠ è½½æ­Œå•æ­Œæ›²
        function loadPlaylistSongs(playlistId) {
            fetch(`/rest/getPlaylist?${authParams}&id=${playlistId}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const playlist = data['subsonic-response'].playlist;
                        const songs = playlist.entry;
                        const songsList = document.getElementById('songsList');
                        songsList.innerHTML = '';

                        if (songs && songs.length > 0) {
                            songs.forEach(song => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <div>
                                        <strong>${song.title}</strong>
                                        <br>
                                        <small>${song.artist} - ${song.album}</small>
                                    </div>
                                    <button class="play-btn" onclick="playSong(${song.id}, '${song.title}', '${song.artist}')">æ’­æ”¾</button>
                                `;
                                songsList.appendChild(li);
                            });
                        } else {
                            songsList.innerHTML = '<li>æ²¡æœ‰æ‰¾åˆ°æ­Œæ›²</li>';
                        }

                        // æ˜¾ç¤ºé¦–é¡µ
                        showSection('home');
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // åˆ›å»ºæ­Œå•
        function createPlaylist() {
            const name = document.getElementById('playlistName').value;
            if (name) {
                fetch(`/rest/createPlaylist?${authParams}&name=${encodeURIComponent(name)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data['subsonic-response'].status === 'ok') {
                            alert('æ­Œå•åˆ›å»ºæˆåŠŸ');
                            document.getElementById('playlistName').value = '';
                            loadPlaylists();
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        // æœç´¢éŸ³ä¹
        function searchMusic() {
            const query = document.getElementById('searchQuery').value;
            if (query) {
                fetch(`/rest/search3?${authParams}&query=${encodeURIComponent(query)}&songCount=20`)
                    .then(response => response.json())
                    .then(data => {
                        if (data['subsonic-response'].status === 'ok') {
                            const songs = data['subsonic-response'].searchResult3.song;
                            
                            if (currentView === 'list') {
                                const songsList = document.getElementById('songsList');
                                songsList.innerHTML = '';

                                if (songs && songs.length > 0) {
                                    songs.forEach(song => {
                                        const li = document.createElement('li');
                                        li.innerHTML = `
                                            <div>
                                                <strong>${song.title}</strong>
                                                <br>
                                                <small>${song.artist} - ${song.album}</small>
                                                <br>
                                                <small>æ ¼å¼: ${song.format || 'æœªçŸ¥'} | è´¨é‡: ${song.quality || 'æœªçŸ¥'} | æ—¶é•¿: ${song.duration || 0}ç§’</small>
                                            </div>
                                            <button class="play-btn" onclick="playSong(${song.id}, '${song.title}', '${song.artist}')">æ’­æ”¾</button>
                                        `;
                                        songsList.appendChild(li);
                                    });
                                } else {
                                    songsList.innerHTML = '<li>æ²¡æœ‰æ‰¾åˆ°æ­Œæ›²</li>';
                                }
                            } else if (currentView === 'card') {
                                const songsCard = document.getElementById('songsCard');
                                songsCard.innerHTML = '';

                                if (songs && songs.length > 0) {
                                    songs.forEach(song => {
                                        const card = document.createElement('div');
                                        card.className = 'song-card';
                                        const coverArt = song.coverArt ? `<img src="/music/${song.coverArt.split('/').pop()}" alt="${song.album}" class="card-cover">` : '<div class="card-cover-placeholder">æ— å°é¢</div>';
                                        card.innerHTML = `
                                            <div class="card-cover-container">
                                                ${coverArt}
                                            </div>
                                            <h4>${song.title}</h4>
                                            <p>${song.artist} - ${song.album}</p>
                                            <button class="btn" onclick="playSong(${song.id}, '${song.title}', '${song.artist}')">æ’­æ”¾</button>
                                        `;
                                        songsCard.appendChild(card);
                                    });
                                } else {
                                    songsCard.innerHTML = '<p>æ²¡æœ‰æ‰¾åˆ°æ­Œæ›²</p>';
                                }
                            }
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        // æ’­æ”¾æ­Œæ›²
        function playSong(id, title, artist) {
            currentSong = { id, title, artist };
            document.getElementById('currentSongTitle').textContent = title;
            document.getElementById('currentSongArtist').textContent = artist;
            document.getElementById('player').style.display = 'block';

            const audioPlayer = document.getElementById('audioPlayer');
            const playButton = document.querySelector('.player-controls .btn:first-child');
            audioPlayer.src = `/rest/stream?${authParams}&id=${id}`;
            audioPlayer.play();
            playButton.textContent = 'æš‚åœ';
        }

        // æ’­æ”¾/æš‚åœ
        function playPause() {
            const audioPlayer = document.getElementById('audioPlayer');
            const playButton = document.querySelector('.player-controls .btn:first-child');
            if (audioPlayer.paused) {
                audioPlayer.play();
                playButton.textContent = 'æš‚åœ';
            } else {
                audioPlayer.pause();
                playButton.textContent = 'æ’­æ”¾';
            }
        }

        // åœæ­¢
        function stop() {
            const audioPlayer = document.getElementById('audioPlayer');
            const playButton = document.querySelector('.player-controls .btn:first-child');
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            playButton.textContent = 'æ’­æ”¾';
        }

        // åˆ‡æ¢è§†å›¾
        function switchView(view) {
            currentView = view;
            const songsList = document.getElementById('songsList');
            const songsCard = document.getElementById('songsCard');
            
            if (view === 'list') {
                songsList.style.display = 'block';
                songsCard.style.display = 'none';
            } else if (view === 'card') {
                songsList.style.display = 'none';
                songsCard.style.display = 'grid';
                // é‡æ–°åŠ è½½æ­Œæ›²ä»¥æ˜¾ç¤ºå¡ç‰‡è§†å›¾
                loadSongs();
            }
        }

        // æ”¹å˜é¡µç 
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage > 0) {
                currentPage = newPage;
                document.getElementById('pageInfo').textContent = `ç¬¬ ${currentPage} é¡µ`;
                loadSongs();
            }
        }

        // ä¸Šä¼ éŸ³ä¹
        function uploadMusic() {
            const form = document.getElementById('uploadForm');
            const formData = new FormData(form);
            const resultDiv = document.getElementById('uploadResult');

            resultDiv.innerHTML = '<p>ä¸Šä¼ ä¸­...</p>';

            fetch(`/upload?${authParams}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = '<p style="color: green;">ä¸Šä¼ æˆåŠŸï¼</p>';
                    // é‡ç½®è¡¨å•
                    form.reset();
                    // åˆ·æ–°é¦–é¡µæ­Œæ›²åˆ—è¡¨
                    if (document.getElementById('home').style.display !== 'none') {
                        loadSongs();
                    }
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">ä¸Šä¼ å¤±è´¥ï¼š${data.error}</p>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<p style="color: red;">ä¸Šä¼ é”™è¯¯ï¼š${error.message}</p>`;
                console.error('Error:', error);
            });
        }
        
        // æ‰‹åŠ¨åŒæ­¥éŸ³ä¹
        function syncMusic() {
            const resultDiv = document.getElementById('syncResult');

            resultDiv.innerHTML = '<p>åŒæ­¥ä¸­...</p>';

            fetch(`/rest/syncMusic?${authParams}`, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if (data['subsonic-response'].status === 'ok') {
                    resultDiv.innerHTML = '<p style="color: green;">åŒæ­¥æˆåŠŸï¼</p>';
                    // åˆ·æ–°é¦–é¡µæ­Œæ›²åˆ—è¡¨
                    if (document.getElementById('home').style.display !== 'none') {
                        loadSongs();
                    }
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">åŒæ­¥å¤±è´¥ï¼š${data['subsonic-response'].error.message}</p>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<p style="color: red;">åŒæ­¥é”™è¯¯ï¼š${error.message}</p>`;
                console.error('Error:', error);
            });
        }
        
        // å…¨å±€å˜é‡ï¼Œå­˜å‚¨å½“å‰WebDAVé…ç½®å’Œè·¯å¾„
        let currentWebdavConfig = null;
        let currentWebdavPath = '/';

        // åŠ è½½WebDAVé…ç½®åˆ—è¡¨
        function loadWebdavConfig() {
            fetch(`/rest/getWebdavConfig?${authParams}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const configs = data['subsonic-response'].webdavConfig;
                        const webdavList = document.getElementById('webdavList');
                        webdavList.innerHTML = '';

                        if (configs && configs.length > 0) {
                            configs.forEach(config => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <div>
                                        <strong>${config.url}</strong>
                                        <br>
                                        <small>ç”¨æˆ·å: ${config.username}</small>
                                        <br>
                                        <small>æœ€ååŒæ­¥: ${config.lastSync || 'æœªåŒæ­¥'}</small>
                                    </div>
                                    <div>
                                        <button class="btn" onclick="browseWebdav('${config.id}')">æµè§ˆ</button>
                                        <button class="btn" onclick="removeWebdavConfig('${config.id}')">åˆ é™¤</button>
                                    </div>
                                `;
                                webdavList.appendChild(li);
                            });
                        } else {
                            webdavList.innerHTML = '<li>æ²¡æœ‰é…ç½®WebDAV</li>';
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
        }
        
        // æ·»åŠ WebDAVé…ç½®
        function addWebdavConfig() {
            const url = document.getElementById('webdavUrl').value;
            const username = document.getElementById('webdavUsername').value;
            const password = document.getElementById('webdavPassword').value;
            const resultDiv = document.getElementById('webdavResult');

            if (!url || !username || !password) {
                resultDiv.innerHTML = '<p style="color: red;">è¯·å¡«å†™æ‰€æœ‰å­—æ®µ</p>';
                return;
            }

            resultDiv.innerHTML = '<p>æ·»åŠ ä¸­...</p>';

            fetch(`/rest/addWebdavConfig?${authParams}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url, username, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data['subsonic-response'].status === 'ok') {
                    resultDiv.innerHTML = '<p style="color: green;">æ·»åŠ æˆåŠŸï¼</p>';
                    // é‡ç½®è¡¨å•
                    document.getElementById('webdavUrl').value = '';
                    document.getElementById('webdavUsername').value = '';
                    document.getElementById('webdavPassword').value = '';
                    // é‡æ–°åŠ è½½WebDAVé…ç½®åˆ—è¡¨
                    loadWebdavConfig();
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">æ·»åŠ å¤±è´¥ï¼š${data['subsonic-response'].error.message}</p>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<p style="color: red;">æ·»åŠ é”™è¯¯ï¼š${error.message}</p>`;
                console.error('Error:', error);
            });
        }
        
        // åˆ é™¤WebDAVé…ç½®
        function removeWebdavConfig(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªWebDAVé…ç½®å—ï¼Ÿ')) {
                fetch(`/rest/removeWebdavConfig?${authParams}&id=${id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data['subsonic-response'].status === 'ok') {
                            // é‡æ–°åŠ è½½WebDAVé…ç½®åˆ—è¡¨
                            loadWebdavConfig();
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }
        
        // æµè§ˆWebDAVæ–‡ä»¶
        function browseWebdav(configId) {
            currentWebdavConfig = configId;
            currentWebdavPath = '/';
            document.getElementById('currentWebdavPath').textContent = currentWebdavPath;
            document.getElementById('webdavBrowser').style.display = 'block';
            loadWebdavFiles();
        }

        // åŠ è½½WebDAVæ–‡ä»¶åˆ—è¡¨
        function loadWebdavFiles() {
            const filesList = document.getElementById('webdavFilesList');
            filesList.innerHTML = '<li>åŠ è½½ä¸­...</li>';

            fetch(`/rest/getWebdavFiles?${authParams}&configId=${currentWebdavConfig}&path=${encodeURIComponent(currentWebdavPath)}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const files = data['subsonic-response'].webdavFiles;
                        filesList.innerHTML = '';

                        if (files && files.length > 0) {
                            files.forEach(file => {
                                const li = document.createElement('li');
                                if (file.type === 'directory') {
                                    li.innerHTML = `
                                        <div>
                                            <strong>ğŸ“ ${file.basename}</strong>
                                        </div>
                                        <button class="btn" onclick="navigateWebdav('${file.path}')">è¿›å…¥</button>
                                    `;
                                } else if (file.type === 'file') {
                                    li.innerHTML = `
                                        <div>
                                            <strong>ğŸµ ${file.basename}</strong>
                                        </div>
                                        <button class="btn" onclick="playWebdavSong('${file.path}', '${file.basename}')">æ’­æ”¾</button>
                                    `;
                                }
                                filesList.appendChild(li);
                            });
                        } else {
                            filesList.innerHTML = '<li>æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶</li>';
                        }
                    } else {
                        filesList.innerHTML = `<li>åŠ è½½å¤±è´¥ï¼š${data['subsonic-response'].error.message}</li>`;
                    }
                })
                .catch(error => {
                    filesList.innerHTML = `<li>åŠ è½½é”™è¯¯ï¼š${error.message}</li>`;
                    console.error('Error:', error);
                });
        }

        // å¯¼èˆªWebDAVç›®å½•
        function navigateWebdav(path) {
            currentWebdavPath = path;
            document.getElementById('currentWebdavPath').textContent = currentWebdavPath;
            loadWebdavFiles();
        }

        // å¯¼èˆªåˆ°ä¸Šä¸€çº§ç›®å½•
        function navigateWebdavUp() {
            if (currentWebdavPath !== '/') {
                const pathParts = currentWebdavPath.split('/');
                pathParts.pop();
                currentWebdavPath = pathParts.join('/') || '/';
                document.getElementById('currentWebdavPath').textContent = currentWebdavPath;
                loadWebdavFiles();
            }
        }

        // æ’­æ”¾WebDAVæ­Œæ›²
        function playWebdavSong(path, filename) {
            currentSong = { id: path, title: filename, artist: 'WebDAV' };
            document.getElementById('currentSongTitle').textContent = filename;
            document.getElementById('currentSongArtist').textContent = 'WebDAV';
            document.getElementById('player').style.display = 'block';

            const audioPlayer = document.getElementById('audioPlayer');
            const playButton = document.querySelector('.player-controls .btn:first-child');
            audioPlayer.src = `/rest/streamWebdav?${authParams}&configId=${currentWebdavConfig}&path=${encodeURIComponent(path)}`;
            audioPlayer.play();
            playButton.textContent = 'æš‚åœ';
        }
    </script>
</body>
</html>