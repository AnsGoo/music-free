<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音乐服务器</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: #4CAF50;
            color: white;
            padding: 10px 0;
            text-align: center;
            margin-bottom: 20px;
        }

        h1 {
            font-size: 24px;
        }

        .login-form {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 50px auto;
        }

        .login-form h2 {
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 16px;
        }

        .btn:hover {
            background-color: #45a049;
        }

        .btn-block {
            width: 100%;
        }

        .content {
            display: none;
        }

        .nav {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .nav ul {
            list-style: none;
            display: flex;
            gap: 10px;
        }

        .nav li {
            margin-right: 10px;
        }

        .nav a {
            text-decoration: none;
            color: #333;
            padding: 5px 10px;
            border-radius: 3px;
        }

        .nav a:hover {
            background-color: #f0f0f0;
        }

        .section {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .section h2 {
            margin-bottom: 15px;
        }

        .search-bar {
            display: flex;
            margin-bottom: 20px;
        }

        .search-bar input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px 0 0 3px;
        }

        .search-bar button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 0 3px 3px 0;
            cursor: pointer;
        }

        .list {
            list-style: none;
        }

        .list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .list li:hover {
            background-color: #f9f9f9;
        }

        .list li:last-child {
            border-bottom: none;
        }

        .play-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 3px;
            padding: 5px 10px;
            cursor: pointer;
        }

        .play-btn:hover {
            background-color: #45a049;
        }

        .player {
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .player-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .player-info {
            flex: 1;
        }

        .player-controls {
            display: flex;
            gap: 10px;
        }

        .player audio {
            width: 100%;
            margin-top: 10px;
        }

        .create-playlist {
            margin-bottom: 20px;
        }

        .create-playlist input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 3px;
            margin-right: 10px;
        }

        .view-controls {
            margin: 15px 0;
            display: flex;
            gap: 10px;
        }

        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
        }

        .song-card {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
            transition: transform 0.2s;
        }

        .song-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .song-card h4 {
            margin-bottom: 10px;
        }

        .song-card p {
            margin-bottom: 15px;
            color: #666;
        }

        .card-cover-container {
            width: 100%;
            height: 200px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border-radius: 5px;
            background-color: #f0f0f0;
        }

        .card-cover {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .card-cover-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e0e0e0;
            color: #999;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .nav ul {
                flex-direction: column;
            }

            .player-content {
                flex-direction: column;
                align-items: flex-start;
            }

            .player-controls {
                margin-top: 10px;
            }

            .card-container {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>音乐服务器</h1>
    </header>

    <div class="container">
        <!-- 登录表单 -->
        <div class="login-form" id="loginForm">
            <h2>登录</h2>
            <div class="form-group">
                <label for="username">用户名</label>
                <input type="text" id="username" placeholder="admin" value="admin">
            </div>
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" placeholder="admin" value="admin">
            </div>
            <button class="btn btn-block" onclick="login()">登录</button>
        </div>

        <!-- 主内容 -->
        <div class="content" id="content">
            <!-- 导航 -->
            <nav class="nav">
                <ul>
                    <li><a href="#" onclick="showSection('home')">首页</a></li>
                    <li><a href="#" onclick="showSection('artists')">艺术家</a></li>
                    <li><a href="#" onclick="showSection('albums')">专辑</a></li>
                    <li><a href="#" onclick="showSection('playlists')">歌单</a></li>
                    <li><a href="#" onclick="showSection('upload')">上传</a></li>
                    <li><a href="#" onclick="showSection('sync')">同步</a></li>
                    <li><a href="#" onclick="showSection('webdav')">WebDAV</a></li>
                    <li><a href="#" onclick="showSection('deduplicate')">去重</a></li>
                    <li><a href="#" onclick="logout()">退出</a></li>
                </ul>
            </nav>

            <!-- 首页 -->
            <div class="section" id="home">
                <h2>首页</h2>
                <div class="search-bar">
                    <input type="text" id="searchQuery" placeholder="搜索音乐...">
                    <button onclick="searchMusic()">搜索</button>
                </div>
                <div class="view-controls">
                    <button class="btn" onclick="switchView('list')">列表视图</button>
                    <button class="btn" onclick="switchView('card')">卡视图</button>
                </div>
                <h3>热门歌曲</h3>
                <div id="songsContainer">
                    <ul class="list" id="songsList">
                        <!-- 歌曲列表将通过JavaScript动态添加 -->
                    </ul>
                    <div class="card-container" id="songsCard" style="display: none;">
                        <!-- 歌曲卡片将通过JavaScript动态添加 -->
                    </div>
                    <div id="pagination" style="margin-top: 20px; text-align: center;">
                        <button class="btn" onclick="changePage(-1)">上一页</button>
                        <span id="pageInfo">第 1 页</span>
                        <button class="btn" onclick="changePage(1)">下一页</button>
                    </div>
                </div>
            </div>

            <!-- 艺术家 -->
            <div class="section" id="artists" style="display: none;">
                <h2>艺术家</h2>
                <ul class="list" id="artistsList">
                    <!-- 艺术家列表将通过JavaScript动态添加 -->
                </ul>
            </div>

            <!-- 专辑 -->
            <div class="section" id="albums" style="display: none;">
                <h2>专辑</h2>
                <ul class="list" id="albumsList">
                    <!-- 专辑列表将通过JavaScript动态添加 -->
                </ul>
            </div>

            <!-- 歌单 -->
            <div class="section" id="playlists" style="display: none;">
                <h2>歌单</h2>
                <div class="create-playlist">
                    <input type="text" id="playlistName" placeholder="歌单名称">
                    <button class="btn" onclick="createPlaylist()">创建歌单</button>
                </div>
                <ul class="list" id="playlistsList">
                    <!-- 歌单列表将通过JavaScript动态添加 -->
                </ul>
            </div>

            <!-- 上传 -->
            <div class="section" id="upload" style="display: none;">
                <h2>上传音乐</h2>
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="form-group">
                        <label for="file">选择文件</label>
                        <input type="file" id="file" name="file" accept=".mp3,.wav,.flac,.ogg" required>
                    </div>
                    <div class="form-group">
                        <label for="uploadTitle">歌曲标题 (可选，自动提取)</label>
                        <input type="text" id="uploadTitle" name="title" placeholder="歌曲标题">
                    </div>
                    <div class="form-group">
                        <label for="uploadArtist">艺术家 (可选，自动提取)</label>
                        <input type="text" id="uploadArtist" name="artist" placeholder="艺术家">
                    </div>
                    <div class="form-group">
                        <label for="uploadAlbum">专辑 (可选，自动提取)</label>
                        <input type="text" id="uploadAlbum" name="album" placeholder="专辑">
                    </div>
                    <div class="form-group">
                        <label for="uploadFormat">格式 (可选，自动提取)</label>
                        <input type="text" id="uploadFormat" name="format" placeholder="如: MP3">
                    </div>
                    <div class="form-group">
                        <label for="uploadEncoding">编码 (可选)</label>
                        <input type="text" id="uploadEncoding" name="encoding" placeholder="如: CBR 320kbps">
                    </div>
                    <div class="form-group">
                        <label for="uploadTrack">轨道 (可选，自动提取)</label>
                        <input type="number" id="uploadTrack" name="track" placeholder="如: 1">
                    </div>
                    <div class="form-group">
                        <label for="uploadDuration">时长(秒) (可选，自动提取)</label>
                        <input type="number" id="uploadDuration" name="duration" placeholder="如: 180">
                    </div>
                    <div class="form-group">
                        <label for="uploadQuality">音质 (可选)</label>
                        <input type="text" id="uploadQuality" name="quality" placeholder="如: 320kbps">
                    </div>
                    <button type="button" class="btn btn-block" onclick="uploadMusic()">上传</button>
                </form>
                <div id="uploadResult" style="margin-top: 20px;"></div>
            </div>
            
            <!-- 同步 -->
            <div class="section" id="sync" style="display: none;">
                <h2>音乐同步</h2>
                <div class="form-group">
                    <label>同步状态</label>
                    <div id="syncStatus" style="padding: 10px; background-color: #f0f0f0; border-radius: 3px;">
                        同步服务已启动，每5分钟自动同步一次
                    </div>
                </div>
                <div class="form-group">
                    <label>同步目录</label>
                    <div style="padding: 10px; background-color: #f0f0f0; border-radius: 3px;">
                        music/
                    </div>
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-block" onclick="syncMusic()">立即同步</button>
                </div>
                <div id="syncResult" style="margin-top: 20px;"></div>
            </div>
            
            <!-- WebDAV -->
            <div class="section" id="webdav" style="display: none;">
                <h2>WebDAV设置</h2>
                <div class="form-group">
                    <h3>添加WebDAV配置</h3>
                    <div class="form-group">
                        <label for="webdavUrl">WebDAV URL</label>
                        <input type="text" id="webdavUrl" placeholder="https://example.com/webdav">
                    </div>
                    <div class="form-group">
                        <label for="webdavUsername">用户名</label>
                        <input type="text" id="webdavUsername" placeholder="Username">
                    </div>
                    <div class="form-group">
                        <label for="webdavPassword">密码</label>
                        <input type="password" id="webdavPassword" placeholder="Password">
                    </div>
                    <button type="button" class="btn btn-block" onclick="addWebdavConfig()">添加</button>
                </div>
                <div class="form-group">
                    <h3>已配置的WebDAV</h3>
                    <ul class="list" id="webdavList">
                        <!-- WebDAV配置列表将通过JavaScript动态添加 -->
                    </ul>
                </div>
                <div class="form-group" id="webdavBrowser" style="display: none;">
                    <h3>WebDAV文件浏览</h3>
                    <div class="form-group">
                        <button type="button" class="btn" onclick="navigateWebdavUp()">上一级</button>
                        <span id="currentWebdavPath">/</span>
                    </div>
                    <ul class="list" id="webdavFilesList">
                        <!-- WebDAV文件列表将通过JavaScript动态添加 -->
                    </ul>
                </div>
                <div id="webdavResult" style="margin-top: 20px;"></div>
            </div>
            
            <!-- 去重 -->
            <div class="section" id="deduplicate" style="display: none;">
                <h2>音乐去重</h2>
                <div class="form-group">
                    <h3>去重设置</h3>
                    <div class="form-group">
                        <label for="deduplicateStrategy">去重策略</label>
                        <select id="deduplicateStrategy" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 3px;">
                            <option value="default">默认 (标题+艺术家+专辑+时长)</option>
                            <option value="strict">严格 (标题+艺术家+专辑+时长+格式)</option>
                            <option value="loose">宽松 (标题+时长)</option>
                        </select>
                    </div>
                    <div class="view-controls" style="margin-top: 10px;">
                        <button class="btn" onclick="detectDuplicates()">检测重复音乐</button>
                        <button class="btn" onclick="autoDeleteDuplicates()">自动删除重复</button>
                    </div>
                </div>
                <div id="duplicatesResult" style="margin-top: 20px;"></div>
                <div id="duplicatesList" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <!-- 播放器 -->
    <div class="player" id="player" style="display: none;">
        <div class="player-content">
            <div class="player-info">
                <h3 id="currentSongTitle">未播放</h3>
                <p id="currentSongArtist">-</p>
            </div>
            <div class="player-controls">
                <button class="btn" onclick="playPause()">播放</button>
                <button class="btn" onclick="stop()">停止</button>
            </div>
        </div>
        <audio id="audioPlayer" controls>
            您的浏览器不支持音频元素。
        </audio>
    </div>

    <script>
        let authParams = '';
        let currentSong = null;
        let currentView = 'list';
        let currentPage = 1;
        let pageSize = 20;

        // 页面加载时检查登录状态
        window.onload = function() {
            const savedAuth = localStorage.getItem('authParams');
            if (savedAuth) {
                authParams = savedAuth;
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('content').style.display = 'block';
                loadHome();
            }
        };

        // 登录
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            authParams = `u=${username}&p=${password}`;
            // 存储登录信息到localStorage
            localStorage.setItem('authParams', authParams);
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('content').style.display = 'block';
            loadHome();
        }

        // 退出
        function logout() {
            authParams = '';
            // 清除localStorage中的登录信息
            localStorage.removeItem('authParams');
            document.getElementById('content').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('player').style.display = 'none';
        }

        // 显示指定部分
        function showSection(sectionId) {
            // 隐藏所有部分
            document.getElementById('home').style.display = 'none';
            document.getElementById('artists').style.display = 'none';
            document.getElementById('albums').style.display = 'none';
            document.getElementById('playlists').style.display = 'none';
            document.getElementById('upload').style.display = 'none';
            document.getElementById('sync').style.display = 'none';
            document.getElementById('webdav').style.display = 'none';
            document.getElementById('deduplicate').style.display = 'none';

            // 显示选中部分
            document.getElementById(sectionId).style.display = 'block';

            // 加载对应内容
            if (sectionId === 'artists') {
                loadArtists();
            } else if (sectionId === 'albums') {
                loadAlbums();
            } else if (sectionId === 'playlists') {
                loadPlaylists();
            } else if (sectionId === 'webdav') {
                loadWebdavConfig();
            }
        }

        // 加载首页
        function loadHome() {
            fetch(`/rest/getIndexes?${authParams}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        loadSongs();
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // 加载歌曲列表
        function loadSongs() {
            const offset = (currentPage - 1) * pageSize;
            fetch(`/rest/search3?${authParams}&query=&songCount=${pageSize}&offset=${offset}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const songs = data['subsonic-response'].searchResult3.song;
                        
                        if (currentView === 'list') {
                            const songsList = document.getElementById('songsList');
                            songsList.innerHTML = '';

                            if (songs && songs.length > 0) {
                                songs.forEach(song => {
                                    const li = document.createElement('li');
                                    li.innerHTML = `
                                        <div>
                                            <strong>${song.title}</strong>
                                            <br>
                                            <small>${song.artist} - ${song.album}</small>
                                            <br>
                                            <small>格式: ${song.format || '未知'} | 质量: ${song.quality || '未知'} | 时长: ${song.duration || 0}秒</small>
                                        </div>
                                        <button class="play-btn" onclick="playSong(${song.id}, '${song.title}', '${song.artist}')">播放</button>
                                    `;
                                    songsList.appendChild(li);
                                });
                            } else {
                                songsList.innerHTML = '<li>没有找到歌曲</li>';
                            }
                        } else if (currentView === 'card') {
                            const songsCard = document.getElementById('songsCard');
                            songsCard.innerHTML = '';

                            if (songs && songs.length > 0) {
                                songs.forEach(song => {
                                    const card = document.createElement('div');
                                    card.className = 'song-card';
                                    const coverArt = song.coverArt ? `<img src="/music/${song.coverArt.split('/').pop()}" alt="${song.album}" class="card-cover">` : '<div class="card-cover-placeholder">无封面</div>';
                                    card.innerHTML = `
                                        <div class="card-cover-container">
                                            ${coverArt}
                                        </div>
                                        <h4>${song.title}</h4>
                                        <p>${song.artist} - ${song.album}</p>
                                        <button class="btn" onclick="playSong(${song.id}, '${song.title}', '${song.artist}')">播放</button>
                                    `;
                                    songsCard.appendChild(card);
                                });
                            } else {
                                songsCard.innerHTML = '<p>没有找到歌曲</p>';
                            }
                        }
                        
                        // 控制分页按钮状态
                        const nextButton = document.querySelector('#pagination button:last-child');
                        const prevButton = document.querySelector('#pagination button:first-child');
                        
                        // 禁用或启用上一页按钮
                        if (currentPage === 1) {
                            prevButton.disabled = true;
                            prevButton.style.opacity = '0.5';
                        } else {
                            prevButton.disabled = false;
                            prevButton.style.opacity = '1';
                        }
                        
                        // 禁用或启用下一页按钮
                        if (!songs || songs.length < pageSize) {
                            nextButton.disabled = true;
                            nextButton.style.opacity = '0.5';
                        } else {
                            nextButton.disabled = false;
                            nextButton.style.opacity = '1';
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // 加载艺术家列表
        function loadArtists() {
            fetch(`/rest/getArtists?${authParams}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const artists = data['subsonic-response'].artists.artist;
                        const artistsList = document.getElementById('artistsList');
                        artistsList.innerHTML = '';

                        if (artists && artists.length > 0) {
                            artists.forEach(artist => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <div>
                                        <strong>${artist.name}</strong>
                                    </div>
                                    <button class="btn" onclick="loadArtistAlbums(${artist.id})">查看专辑</button>
                                `;
                                artistsList.appendChild(li);
                            });
                        } else {
                            artistsList.innerHTML = '<li>没有找到艺术家</li>';
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // 加载艺术家专辑
        function loadArtistAlbums(artistId) {
            fetch(`/rest/getArtist?${authParams}&id=${artistId}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const artist = data['subsonic-response'].artist;
                        const albums = artist.album;
                        const albumsList = document.getElementById('albumsList');
                        albumsList.innerHTML = '';

                        if (albums && albums.length > 0) {
                            albums.forEach(album => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <div>
                                        <strong>${album.name}</strong>
                                        <br>
                                        <small>${artist.name}</small>
                                    </div>
                                    <button class="btn" onclick="loadAlbumSongs(${album.id})">查看歌曲</button>
                                `;
                                albumsList.appendChild(li);
                            });
                        } else {
                            albumsList.innerHTML = '<li>没有找到专辑</li>';
                        }

                        // 显示专辑页面
                        showSection('albums');
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // 加载专辑列表
        function loadAlbums() {
            fetch(`/rest/getAlbumList?${authParams}&type=newest&size=20`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const albums = data['subsonic-response'].albumList.album;
                        const albumsList = document.getElementById('albumsList');
                        albumsList.innerHTML = '';

                        if (albums && albums.length > 0) {
                            albums.forEach(album => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <div>
                                        <strong>${album.name}</strong>
                                        <br>
                                        <small>${album.artist}</small>
                                    </div>
                                    <button class="btn" onclick="loadAlbumSongs(${album.id})">查看歌曲</button>
                                `;
                                albumsList.appendChild(li);
                            });
                        } else {
                            albumsList.innerHTML = '<li>没有找到专辑</li>';
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // 加载专辑歌曲
        function loadAlbumSongs(albumId) {
            fetch(`/rest/getAlbum?${authParams}&id=${albumId}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const album = data['subsonic-response'].album;
                        const songs = album.song;
                        const songsList = document.getElementById('songsList');
                        songsList.innerHTML = '';

                        if (songs && songs.length > 0) {
                            songs.forEach(song => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <div>
                                        <strong>${song.title}</strong>
                                        <br>
                                        <small>${album.artist} - ${album.name}</small>
                                    </div>
                                    <button class="play-btn" onclick="playSong(${song.id}, '${song.title}', '${album.artist}')">播放</button>
                                `;
                                songsList.appendChild(li);
                            });
                        } else {
                            songsList.innerHTML = '<li>没有找到歌曲</li>';
                        }

                        // 显示首页
                        showSection('home');
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // 加载歌单列表
        function loadPlaylists() {
            fetch(`/rest/getPlaylists?${authParams}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const playlists = data['subsonic-response'].playlists.playlist;
                        const playlistsList = document.getElementById('playlistsList');
                        playlistsList.innerHTML = '';

                        if (playlists && playlists.length > 0) {
                            playlists.forEach(playlist => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <div>
                                        <strong>${playlist.name}</strong>
                                        <br>
                                        <small>创建于: ${new Date(playlist.created).toLocaleString()}</small>
                                    </div>
                                    <button class="btn" onclick="loadPlaylistSongs(${playlist.id})">查看歌曲</button>
                                `;
                                playlistsList.appendChild(li);
                            });
                        } else {
                            playlistsList.innerHTML = '<li>没有找到歌单</li>';
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // 加载歌单歌曲
        function loadPlaylistSongs(playlistId) {
            fetch(`/rest/getPlaylist?${authParams}&id=${playlistId}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const playlist = data['subsonic-response'].playlist;
                        const songs = playlist.entry;
                        const songsList = document.getElementById('songsList');
                        songsList.innerHTML = '';

                        if (songs && songs.length > 0) {
                            songs.forEach(song => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <div>
                                        <strong>${song.title}</strong>
                                        <br>
                                        <small>${song.artist} - ${song.album}</small>
                                    </div>
                                    <button class="play-btn" onclick="playSong(${song.id}, '${song.title}', '${song.artist}')">播放</button>
                                `;
                                songsList.appendChild(li);
                            });
                        } else {
                            songsList.innerHTML = '<li>没有找到歌曲</li>';
                        }

                        // 显示首页
                        showSection('home');
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // 创建歌单
        function createPlaylist() {
            const name = document.getElementById('playlistName').value;
            if (name) {
                fetch(`/rest/createPlaylist?${authParams}&name=${encodeURIComponent(name)}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data['subsonic-response'].status === 'ok') {
                            alert('歌单创建成功');
                            document.getElementById('playlistName').value = '';
                            loadPlaylists();
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        // 搜索音乐
        function searchMusic() {
            const query = document.getElementById('searchQuery').value;
            if (query) {
                fetch(`/rest/search3?${authParams}&query=${encodeURIComponent(query)}&songCount=20`)
                    .then(response => response.json())
                    .then(data => {
                        if (data['subsonic-response'].status === 'ok') {
                            const songs = data['subsonic-response'].searchResult3.song;
                            
                            if (currentView === 'list') {
                                const songsList = document.getElementById('songsList');
                                songsList.innerHTML = '';

                                if (songs && songs.length > 0) {
                                    songs.forEach(song => {
                                        const li = document.createElement('li');
                                        li.innerHTML = `
                                            <div>
                                                <strong>${song.title}</strong>
                                                <br>
                                                <small>${song.artist} - ${song.album}</small>
                                                <br>
                                                <small>格式: ${song.format || '未知'} | 质量: ${song.quality || '未知'} | 时长: ${song.duration || 0}秒</small>
                                            </div>
                                            <button class="play-btn" onclick="playSong(${song.id}, '${song.title}', '${song.artist}')">播放</button>
                                        `;
                                        songsList.appendChild(li);
                                    });
                                } else {
                                    songsList.innerHTML = '<li>没有找到歌曲</li>';
                                }
                            } else if (currentView === 'card') {
                                const songsCard = document.getElementById('songsCard');
                                songsCard.innerHTML = '';

                                if (songs && songs.length > 0) {
                                    songs.forEach(song => {
                                        const card = document.createElement('div');
                                        card.className = 'song-card';
                                        const coverArt = song.coverArt ? `<img src="/music/${song.coverArt.split('/').pop()}" alt="${song.album}" class="card-cover">` : '<div class="card-cover-placeholder">无封面</div>';
                                        card.innerHTML = `
                                            <div class="card-cover-container">
                                                ${coverArt}
                                            </div>
                                            <h4>${song.title}</h4>
                                            <p>${song.artist} - ${song.album}</p>
                                            <button class="btn" onclick="playSong(${song.id}, '${song.title}', '${song.artist}')">播放</button>
                                        `;
                                        songsCard.appendChild(card);
                                    });
                                } else {
                                    songsCard.innerHTML = '<p>没有找到歌曲</p>';
                                }
                            }
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }

        // 播放歌曲
        function playSong(id, title, artist) {
            currentSong = { id, title, artist };
            document.getElementById('currentSongTitle').textContent = title;
            document.getElementById('currentSongArtist').textContent = artist;
            document.getElementById('player').style.display = 'block';

            const audioPlayer = document.getElementById('audioPlayer');
            const playButton = document.querySelector('.player-controls .btn:first-child');
            audioPlayer.src = `/rest/stream?${authParams}&id=${id}`;
            audioPlayer.play();
            playButton.textContent = '暂停';
        }

        // 播放/暂停
        function playPause() {
            const audioPlayer = document.getElementById('audioPlayer');
            const playButton = document.querySelector('.player-controls .btn:first-child');
            if (audioPlayer.paused) {
                audioPlayer.play();
                playButton.textContent = '暂停';
            } else {
                audioPlayer.pause();
                playButton.textContent = '播放';
            }
        }

        // 停止
        function stop() {
            const audioPlayer = document.getElementById('audioPlayer');
            const playButton = document.querySelector('.player-controls .btn:first-child');
            audioPlayer.pause();
            audioPlayer.currentTime = 0;
            playButton.textContent = '播放';
        }

        // 切换视图
        function switchView(view) {
            currentView = view;
            const songsList = document.getElementById('songsList');
            const songsCard = document.getElementById('songsCard');
            
            if (view === 'list') {
                songsList.style.display = 'block';
                songsCard.style.display = 'none';
            } else if (view === 'card') {
                songsList.style.display = 'none';
                songsCard.style.display = 'grid';
                // 重新加载歌曲以显示卡片视图
                loadSongs();
            }
        }

        // 改变页码
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage > 0) {
                currentPage = newPage;
                document.getElementById('pageInfo').textContent = `第 ${currentPage} 页`;
                loadSongs();
            }
        }

        // 上传音乐
        function uploadMusic() {
            const form = document.getElementById('uploadForm');
            const formData = new FormData(form);
            const resultDiv = document.getElementById('uploadResult');

            resultDiv.innerHTML = '<p>上传中...</p>';

            fetch(`/upload?${authParams}`, {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.innerHTML = '<p style="color: green;">上传成功！</p>';
                    // 重置表单
                    form.reset();
                    // 刷新首页歌曲列表
                    if (document.getElementById('home').style.display !== 'none') {
                        loadSongs();
                    }
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">上传失败：${data.error}</p>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<p style="color: red;">上传错误：${error.message}</p>`;
                console.error('Error:', error);
            });
        }
        
        // 手动同步音乐
        function syncMusic() {
            const resultDiv = document.getElementById('syncResult');

            resultDiv.innerHTML = '<p>同步中...</p>';

            fetch(`/rest/syncMusic?${authParams}`, {
                method: 'GET'
            })
            .then(response => response.json())
            .then(data => {
                if (data['subsonic-response'].status === 'ok') {
                    resultDiv.innerHTML = '<p style="color: green;">同步成功！</p>';
                    // 刷新首页歌曲列表
                    if (document.getElementById('home').style.display !== 'none') {
                        loadSongs();
                    }
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">同步失败：${data['subsonic-response'].error.message}</p>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<p style="color: red;">同步错误：${error.message}</p>`;
                console.error('Error:', error);
            });
        }
        
        // 全局变量，存储当前WebDAV配置和路径
        let currentWebdavConfig = null;
        let currentWebdavPath = '/';

        // 加载WebDAV配置列表
        function loadWebdavConfig() {
            fetch(`/rest/getWebdavConfig?${authParams}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const configs = data['subsonic-response'].webdavConfig;
                        const webdavList = document.getElementById('webdavList');
                        webdavList.innerHTML = '';

                        if (configs && configs.length > 0) {
                            configs.forEach(config => {
                                const li = document.createElement('li');
                                li.innerHTML = `
                                    <div>
                                        <strong>${config.url}</strong>
                                        <br>
                                        <small>用户名: ${config.username}</small>
                                        <br>
                                        <small>最后同步: ${config.lastSync || '未同步'}</small>
                                    </div>
                                    <div>
                                        <button class="btn" onclick="browseWebdav('${config.id}')">浏览</button>
                                        <button class="btn" onclick="removeWebdavConfig('${config.id}')">删除</button>
                                    </div>
                                `;
                                webdavList.appendChild(li);
                            });
                        } else {
                            webdavList.innerHTML = '<li>没有配置WebDAV</li>';
                        }
                    }
                })
                .catch(error => console.error('Error:', error));
        }
        
        // 添加WebDAV配置
        function addWebdavConfig() {
            const url = document.getElementById('webdavUrl').value;
            const username = document.getElementById('webdavUsername').value;
            const password = document.getElementById('webdavPassword').value;
            const resultDiv = document.getElementById('webdavResult');

            if (!url || !username || !password) {
                resultDiv.innerHTML = '<p style="color: red;">请填写所有字段</p>';
                return;
            }

            resultDiv.innerHTML = '<p>添加中...</p>';

            fetch(`/rest/addWebdavConfig?${authParams}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ url, username, password })
            })
            .then(response => response.json())
            .then(data => {
                if (data['subsonic-response'].status === 'ok') {
                    resultDiv.innerHTML = '<p style="color: green;">添加成功！</p>';
                    // 重置表单
                    document.getElementById('webdavUrl').value = '';
                    document.getElementById('webdavUsername').value = '';
                    document.getElementById('webdavPassword').value = '';
                    // 重新加载WebDAV配置列表
                    loadWebdavConfig();
                } else {
                    resultDiv.innerHTML = `<p style="color: red;">添加失败：${data['subsonic-response'].error.message}</p>`;
                }
            })
            .catch(error => {
                resultDiv.innerHTML = `<p style="color: red;">添加错误：${error.message}</p>`;
                console.error('Error:', error);
            });
        }
        
        // 删除WebDAV配置
        function removeWebdavConfig(id) {
            if (confirm('确定要删除这个WebDAV配置吗？')) {
                fetch(`/rest/removeWebdavConfig?${authParams}&id=${id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data['subsonic-response'].status === 'ok') {
                            // 重新加载WebDAV配置列表
                            loadWebdavConfig();
                        }
                    })
                    .catch(error => console.error('Error:', error));
            }
        }
        
        // 浏览WebDAV文件
        function browseWebdav(configId) {
            currentWebdavConfig = configId;
            currentWebdavPath = '/';
            document.getElementById('currentWebdavPath').textContent = currentWebdavPath;
            document.getElementById('webdavBrowser').style.display = 'block';
            loadWebdavFiles();
        }

        // 加载WebDAV文件列表
        function loadWebdavFiles() {
            const filesList = document.getElementById('webdavFilesList');
            filesList.innerHTML = '<li>加载中...</li>';

            fetch(`/rest/getWebdavFiles?${authParams}&configId=${currentWebdavConfig}&path=${encodeURIComponent(currentWebdavPath)}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const files = data['subsonic-response'].webdavFiles;
                        filesList.innerHTML = '';

                        if (files && files.length > 0) {
                            files.forEach(file => {
                                const li = document.createElement('li');
                                if (file.type === 'directory') {
                                    li.innerHTML = `
                                        <div>
                                            <strong>📁 ${file.basename}</strong>
                                        </div>
                                        <button class="btn" onclick="navigateWebdav('${file.path}')">进入</button>
                                    `;
                                } else if (file.type === 'file') {
                                    li.innerHTML = `
                                        <div>
                                            <strong>🎵 ${file.basename}</strong>
                                        </div>
                                        <button class="btn" onclick="playWebdavSong('${file.path}', '${file.basename}')">播放</button>
                                    `;
                                }
                                filesList.appendChild(li);
                            });
                        } else {
                            filesList.innerHTML = '<li>没有找到文件</li>';
                        }
                    } else {
                        filesList.innerHTML = `<li>加载失败：${data['subsonic-response'].error.message}</li>`;
                    }
                })
                .catch(error => {
                    filesList.innerHTML = `<li>加载错误：${error.message}</li>`;
                    console.error('Error:', error);
                });
        }

        // 导航WebDAV目录
        function navigateWebdav(path) {
            currentWebdavPath = path;
            document.getElementById('currentWebdavPath').textContent = currentWebdavPath;
            loadWebdavFiles();
        }

        // 导航到上一级目录
        function navigateWebdavUp() {
            if (currentWebdavPath !== '/') {
                const pathParts = currentWebdavPath.split('/');
                pathParts.pop();
                currentWebdavPath = pathParts.join('/') || '/';
                document.getElementById('currentWebdavPath').textContent = currentWebdavPath;
                loadWebdavFiles();
            }
        }

        // 播放WebDAV歌曲
        function playWebdavSong(path, filename) {
            currentSong = { id: path, title: filename, artist: 'WebDAV' };
            document.getElementById('currentSongTitle').textContent = filename;
            document.getElementById('currentSongArtist').textContent = 'WebDAV';
            document.getElementById('player').style.display = 'block';

            const audioPlayer = document.getElementById('audioPlayer');
            const playButton = document.querySelector('.player-controls .btn:first-child');
            audioPlayer.src = `/rest/streamWebdav?${authParams}&configId=${currentWebdavConfig}&path=${encodeURIComponent(path)}`;
            audioPlayer.play();
            playButton.textContent = '暂停';
        }
        
        // 检测重复音乐
        function detectDuplicates() {
            const resultDiv = document.getElementById('duplicatesResult');
            const listDiv = document.getElementById('duplicatesList');
            const strategy = document.getElementById('deduplicateStrategy').value;
            
            resultDiv.innerHTML = '<p>检测中...</p>';
            listDiv.innerHTML = '';
            
            fetch(`/rest/detectDuplicates?${authParams}&strategy=${strategy}`)
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const duplicates = data['subsonic-response'].duplicates;
                        
                        if (duplicates && duplicates.length > 0) {
                            resultDiv.innerHTML = `<p style="color: green;">找到 ${duplicates.length} 组重复音乐</p>`;
                            
                            duplicates.forEach((group, index) => {
                                const groupDiv = document.createElement('div');
                                groupDiv.className = 'form-group';
                                groupDiv.style.marginBottom = '20px';
                                groupDiv.style.padding = '15px';
                                groupDiv.style.backgroundColor = '#f9f9f9';
                                groupDiv.style.borderRadius = '5px';
                                
                                // 格式化文件大小
                                function formatFileSize(bytes) {
                                    if (bytes === 0) return '0 B';
                                    const k = 1024;
                                    const sizes = ['B', 'KB', 'MB', 'GB'];
                                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                                }
                                
                                groupDiv.innerHTML = `
                                    <h4>重复组 ${index + 1}: ${group[0].title} - ${group[0].artist}</h4>
                                    <p style="margin-bottom: 10px;"><small>建议保留：文件大小最大的版本</small></p>
                                    <ul class="list">
                                        ${group.map((song, songIndex) => `
                                            <li style="${songIndex === 0 ? 'background-color: #e8f5e8;' : ''}">
                                                <div>
                                                    <strong>${song.title}${songIndex === 0 ? ' (建议保留)' : ''}</strong>
                                                    <br>
                                                    <small>艺术家: ${song.artist || '未知'}</small>
                                                    <br>
                                                    <small>专辑: ${song.album || '未知'}</small>
                                                    <br>
                                                    <small>时长: ${song.duration || 0}秒</small>
                                                    <br>
                                                    <small>格式: ${song.format || '未知'}</small>
                                                    <br>
                                                    <small>文件大小: ${formatFileSize(song.file_size || 0)}</small>
                                                    <br>
                                                    <small>文件路径: ${song.file_path}</small>
                                                </div>
                                                <button class="btn" onclick="deleteDuplicate(${song.id})" ${songIndex === 0 ? 'style="opacity: 0.5; cursor: not-allowed;" disabled' : ''}>删除</button>
                                            </li>
                                        `).join('')}
                                    </ul>
                                `;
                                
                                listDiv.appendChild(groupDiv);
                            });
                        } else {
                            resultDiv.innerHTML = '<p style="color: green;">未找到重复音乐</p>';
                            listDiv.innerHTML = '<p>所有音乐都是唯一的</p>';
                        }
                    } else {
                        resultDiv.innerHTML = `<p style="color: red;">检测失败：${data['subsonic-response'].error.message}</p>`;
                    }
                })
                .catch(error => {
                    resultDiv.innerHTML = `<p style="color: red;">检测错误：${error.message}</p>`;
                    console.error('Error:', error);
                });
        }
        
        // 删除重复音乐
        function deleteDuplicate(songId) {
            if (confirm('确定要删除这首歌曲吗？')) {
                fetch(`/rest/deleteDuplicate?${authParams}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ songId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        // 重新检测重复音乐
                        detectDuplicates();
                    } else {
                        alert(`删除失败：${data['subsonic-response'].error.message}`);
                    }
                })
                .catch(error => {
                    alert(`删除错误：${error.message}`);
                    console.error('Error:', error);
                });
            }
        }
        
        // 自动删除重复音乐
        function autoDeleteDuplicates() {
            const resultDiv = document.getElementById('duplicatesResult');
            const strategy = document.getElementById('deduplicateStrategy').value;
            
            if (confirm('确定要自动删除重复音乐吗？系统会保留文件大小最大的版本，删除其他重复版本。')) {
                resultDiv.innerHTML = '<p>自动删除中...</p>';
                
                fetch(`/rest/autoDeleteDuplicates?${authParams}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ strategy })
                })
                .then(response => response.json())
                .then(data => {
                    if (data['subsonic-response'].status === 'ok') {
                        const result = data['subsonic-response'].result;
                        resultDiv.innerHTML = `<p style="color: green;">自动删除完成！共删除了 ${result.deleted} 首重复音乐</p>`;
                        // 重新检测重复音乐
                        setTimeout(detectDuplicates, 1000);
                    } else {
                        resultDiv.innerHTML = `<p style="color: red;">自动删除失败：${data['subsonic-response'].error.message}</p>`;
                    }
                })
                .catch(error => {
                    resultDiv.innerHTML = `<p style="color: red;">自动删除错误：${error.message}</p>`;
                    console.error('Error:', error);
                });
            }
        }
    </script>
</body>
</html>